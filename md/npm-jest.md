<< [На главную](../README.md)

# Jest - тестирование кода

---

Навигация:

- [Jest - тестирование кода](#jest---тестирование-кода)
  - [Jest : Установка](#jest--установка)
  - [Jest : Настройка](#jest--настройка)
  - [Jest : Структура файлов](#jest--структура-файлов)
  - [Jest : Фикстуры](#jest--фикстуры)
    - [`__filename` и `__dirname`](#__filename-и-__dirname)
      - [Создание](#создание)
      - [Использование](#использование)
  - [Jest : матчеры](#jest--матчеры)
    - [Общие](#общие)
    - [Строка](#строка)
    - [Массив](#массив)
    - [Объект](#объект)
  - [Jest : хуки](#jest--хуки)
  - [Jest : перебор данных](#jest--перебор-данных)
  - [Jest : Запуск](#jest--запуск)

---

## Jest : Установка

[Официальный сайт](https://jestjs.io/)

```bash
npm install jest --save-dev
```

## Jest : Настройка

Для поддержки синтаксиса ECMAScript модулей необходимо настроить node.
Добавьте в корень проекта файл `.npmrc`

```bash
node-options=--experimental-vm-modules
```

## Jest : Структура файлов

Файлы тестов располагаются в директории `__tests__` (обычно в корне проекта).  
В этой директории можно создавать любую струкутру. Jest найдёт все тесты.

Именование файлов с тестами должно быть таким: `<name>.test.js`.  
Где `<name>`, как правило, совпадает с названием тестируемого модуля.

Для тестов Jest предоставляет глобальные функции: `test`, `expect` и `describe`;

```js
import reverse from '../src/reverse.js'; // импорт тестируемого модуля
```

```js
// Тест (одна или несколько проверок)
// ————————————————————————————————————————
test('<test_name>', () => {
  expect(reverse('hello')).toEqual('olleh'); // проверка (с помощью матчера)
});
```

Один тест — не обязательно одна проверка.  
Как правило тест — группа проверок, проводимых в процессе выполнения какого-либо сценария.

Иногда тесты (спецнарии) удобно группировать в отдельные смысловые блоки.

```js
// Группа тестов (несколько тестов)
// ————————————————————————————————————————
describe('<group_name>', () => {
  test('<test_name>', () => {
    expect(reverse('hello')).toEqual('olleh');
  });

  test('<test_name>', () => {
    expect(reverse('hello')).toEqual('olleh');
  });
});
```

Это делается крайне редко. В большинстве случаев достаточно простых тестов.

## Jest : Фикстуры

Файлы фикстур располагаются в директории `__fixtures__` (обычно в корне проекта).

### `__filename` и `__dirname`

`__filename` – глобальная константа, содержащая абсолютный путь к файлу, в котором она используется  
`__dirname` – глобальная константа, содержащая абсолютный путь к каталогу.

Зная, что необходимый файл лежит относительно текущего всегда на N каталогов выше/ниже, используя данные константы, можно обеспечить детерминированное поведение при запуске кода из любого каталога.

#### Создание

```js
import { fileURLToPath } from 'url';
import path from 'path';

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);
```

#### Использование

```js
const getFixturePath = (filename) => path.join(__dirname, '..', '__fixtures__', filename);
```

## Jest : матчеры

Методы сравнения полученного и ожидаемого результатов.

- [Документация](https://jestjs.io/docs/expect)

### Общие

```js
.toBe(value) // равенство (по ссылке)
.toEqual(value) // равенство (по значению)
```

```js
.toBeTruthy() // true
.toBeFalsy() // false
.toBeNull() // null
.toBeUndefined() // undefined
```

```js
.not.____() // противоположная проверка
// подходит для всех матчеров
```

```js
expect(() => ____).toThrow(); // Error
expect(() => ____).toThrow('some text'); // текст Error содержит строку 'some text'

// проверяемая функция обёрнута анонимной лямбда-функцией,
// чтобы матчер смог перехватить ошибку
```

### Строка

```js
.toMatch(string | regexp) // содержит подстроку
```

### Массив

```js
.toHaveLength(number) // длина массива
```

```js
.toContain(value) // содержит элемент
```

### Объект

```js
.toHaveProperty(key, value) // ключ, значение (не обязательно)
.toHaveProperty('key.key', value) // ключ (с глубиной), значение (не обязательно)
.toHaveProperty(['key', 'key' ], value); // ключ (с глубиной), значение (не обязательно)
```

```js
.toMatchObject(object) // содержит структуру object как часть себя
```

## Jest : хуки

Функции, запускаемые до или после выполнения каждой из директив `test()`.

- [Документация](https://jestjs.io/docs/api#methods)

```js
beforeEach(() => {}); // перед каждым test()
afterEach(() => {}); // после каждого test()
```

```js
beforeAll(() => {}); // перед всеми тестами (один раз)
afterAll(() => {}); // после всех тестов (один раз)
```

## Jest : перебор данных

Вызов одного теста с несколькими наборами данных

- [Документация](https://jestjs.io/docs/api#testeachtablename-fn-timeout)

```js
test.each(...)('<test_name>', (...) => {...});
```

<details>
<summary>Данные теста – Массив</summary>

```js
test.each([
  [1, 2, 3], // 1 + 2 = 3
  [2, 5, 7], // 2 + 5 = 7
  [0, 4, 4], // 0 + 4 = 4
])('Array', (a, b, expected) => {
  // a + b = expected
  expect(a + b).toBe(expected);
});
```

</details>

<details>
<summary>Данные теста – Объект</summary>

```js
test.each([
  { a: 1, b: 2, expected: 3 }, // 1 + 2 = 3
  { a: 2, b: 5, expected: 7 }, // 2 + 5 = 7
  { a: 0, b: 4, expected: 4 }, // 0 + 4 = 4
])('Object', ({ a, b, expected }) => {
  // a + b = expected
  expect(a + b).toBe(expected);
});
```

</details><br>

## Jest : Запуск

```bash
npx jest              # запуск тестов
npx jest --coverage   # запуск тестов (с расчётом покрытия кода)
```
